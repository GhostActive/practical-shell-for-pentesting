#
# GNU General Public License v3.0
#   
# Copyright (C) 2021 GhostActive
#
# Author
#    GhostActive, https://github.com/ghostactive
#
# Version
#    1.0
#

function flush-history -d "Clear fish history and prefill with commands"

    set LENGTH (count $argv)

    set HISTORY_FILE ~/.local/share/fish/fish_history
    
    # Print help text
    if contains -- "-h" $argv; or contains -- "--help" $argv
        echo ""
        echo "flush-history - Deletes and prefills the fish history"
        echo ""
        echo "Usage: flush-history [FILE]..."
        echo ""
        echo "Options:"
        echo "    -h, --help       Prints this help text"
        echo ""
        echo "Description:"
        echo "    Deletes the fish history and prefill it with given files."
        echo "    Files for prefilling must have a valid fish history format."
        echo ""
        echo "    HINT: As the content of the history file is deleted, it may"
        echo "          be useful to create a backup of the original one before"
        echo "          starting the script, e.g.:"
        echo ""
        echo "          cp ~/.local/share/fish/fish_history ~/history.bak"
        echo ""
        echo "    HINT: Make sure that no other shell sessions are running"
        echo "          during execution."
        echo ""
        echo "Examples:"
        echo "    # Clean fish history"
        echo "    flush-history"
        echo ""
        echo "    # Clean fish history and prefill it with prepared commands"
        echo "    flush-history prepared-admin-cmd.txt prepared-dev-cmd.txt"
        echo ""

        return 0
    end

    # No parameter - just clean fish history
    if test $LENGTH -eq 0
        builtin history clear
        return 0
    end

    # Check whether all given input files exists
    for ITEM in $argv
        if test ! -e $ITEM
            echo "An error occurred: Unknown file '$ITEM'"
            echo ""
            echo "The process was aborted."

            return 1
        end
    end

    # Clean history
    builtin history clear
    
    # Write given files to fish history 
    mkdir -p (dirname $HISTORY_FILE)

    cat $argv > $HISTORY_FILE

    return 0
end
